class EZPZ_BBCode_Parser{#a=[];#b=[];#c=null;#d={inline:["b","i","s","u","link","c","spoiler","img","size","color"],recursive:["box","quote","notice","centre","spoilerbox"]};constructor(e=[]){if(!Array.isArray(e))throw TypeError("templateRules must be an array.");this.setRules(e)}set lineBreakTemplate(e){if("function"!=typeof e)throw TypeError("lineBreakTemplate must be a function.");this.#c=e}set textWrapTags(e){if("object"!=typeof e||!Array.isArray(e.inline)||!Array.isArray(e.recursive))throw TypeError("textWrapTags must be an object with 'inline' and 'recursive' arrays.");this.#d.inline=e.inline,this.#d.recursive=e.recursive}addRule(e){if(!e||"object"!=typeof e)throw TypeError("addRule expects a rule object.");this.#a.push(this.#e(e))}setRules(e){if(!Array.isArray(e))throw TypeError("setRules expects an array of rule objects.");this.#a=e.map(e=>{if(!e||"object"!=typeof e)throw TypeError("Each rule must be an object.");return this.#e(e)})}parse(e,t={wrapText:!1,strictUnknownTag:!0,strictClosingTag:!1}){if("string"!=typeof e)throw TypeError("parse() expects the first argument to be a string.");("object"!=typeof t||null===t)&&(t={});let{wrapText:n=!1,strictUnknownTag:r=!0,strictClosingTag:i=!1}=t,o=e;n&&(o=this.#f(o));let l=[],s=this.#g(o),p=this.#h(s,l,i),a=this.#i(p,{errors:l},r,i);return{output:a,errors:l,tokens:s,tree:p,raw:o}}forbidden(e){if("function"!=typeof e)throw TypeError("forbidden() expects a function.");let t=[],n=(e,n="This is forbidden.")=>{if("function"!=typeof e)throw TypeError("Forbidden check function must be a function.");let r={fn:e,msg:n,handler:null},i=e=>{if("function"!=typeof e)throw TypeError("Forbidden 'then' handler must be a function.");r.handler=e};return t.push(r),{then:i}};e(n),this.#b.push(...t)}#j(e){let t=[],n=null;for(let{fn:r,msg:i,handler:o}of this.#b)if(r(e)&&(t.push({errorType:"forbidden",message:i,...e}),"function"==typeof o)){let l=o(e);void 0!==l&&null===n&&(n=l)}return{messages:t,override:n}}#g(s){let p=[],a=0,u="<<<TAKE_ME_AWAY>>>";s=s.replace(/\\\\\[/g,u),console.log(s);let h=()=>{if("["!==s[a])return null;let e=a+1,t="",n="",r=!1,i=!1,o=0,l=a;if("/"===s[e]&&(r=!0,e++),!r&&"*"===s[e]&&"]"===s[++e]){let p=s.slice(a,e+1),u=e+1;return a=u,{type:"tag-open",name:"*",value:null,raw:p,position:{start:l,end:u}}}for(;e<s.length;){let h=s[e];if(!i&&"="===h){i=!0,e++;continue}if("["===h&&i&&o++,"]"===h){if(o>0)o--;else break}i?n+=h:t+=h,e++}if("]"!==s[e])return null;let d=s.slice(a,e+1),c=e+1;return a=c,{type:r?"tag-close":"tag-open",name:t.trim().toLowerCase(),value:i?n.trim():null,raw:d,position:{start:l,end:c}}};for(;a<s.length;){if("["===s[a]){let d=h();if(d){p.push(d);continue}p.push({type:"text",content:"[",position:{start:a,end:a+1}}),a+=1;continue}let c=s.indexOf("[",a);-1===c&&(c=s.length),p.push({type:"text",content:s.slice(a,c),position:{start:a,end:c}}),a=c}for(let f of p)"text"===f.type&&(f.content=f.content.replace(RegExp(u,"g"),"["));return p}#h(m,g=[],x=!1){let y={type:"root",children:[]},_=[{node:y,token:null}];for(let b=0;b<m.length;b++){let v=m[b],$=_[_.length-1].node;if("text"===v.type)$.children.push({type:"text",content:v.content,position:v.position});else if("tag-open"===v.type){if("*"===v.name){let T={type:"tag",name:"*",value:null,children:[],position:v.position};for(b++;b<m.length&&!("tag-open"===m[b].type&&("*"===m[b].name||"list"===m[b].name))&&!("tag-close"===m[b].type&&"list"===m[b].name);)T.children.push(m[b]),b++;b--,$.children.push(T)}else{let w={type:"tag",name:v.name,value:v.value,children:[],position:v.position,closingPosition:null};$.children.push(w),_.push({node:w,token:v})}}else if("tag-close"===v.type){if(x){let j=_[_.length-1];_.length>1&&j.node.name===v.name?(j.node.closingPosition=v.position,_.pop()):($.children.push({type:"text",content:`[/${v.name}]`,position:v.position}),g?.push({errorType:"unexpected-closing",node:{current:{children:null,closingPosition:null,name:v.name,position:v.position,type:"tag",value:null}},pointer:null}))}else{let A=-1;for(let k=_.length-1;k>=1;k--)if(_[k].node.name===v.name){A=k;break}if(-1!==A){let P=_[A];P.node.closingPosition=v.position,_.splice(A)}else $.children.push({type:"text",content:`[/${v.name}]`,position:v.position}),g?.push({errorType:"unexpected-closing",node:{current:{children:null,closingPosition:null,name:v.name,position:v.position,type:"tag",value:null}},pointer:null})}}}if(x)for(let B=_.length-1;B>=1;B--){let{node:N}=_[B],W=_[B-1].node,Z=W.children.indexOf(N);if(-1!==Z){let R=`[${N.name}${N.value?"="+N.value:""}]`+N.children.map(e=>"text"===e.type?e.content:this.#i(e,{},!0,!1)).join("");W.children[Z]={type:"text",content:R,position:N.position}}g?.push({errorType:"unclosed-tag",node:{current:N,parent:null,root:null,next:null,previous:null},pointer:null})}return y}#i(E,C={},z=!0,L=!1){if("text"===E.type){if("function"==typeof this.#c){let F={index:C.index??0,path:C.path??"0",depth:(C.path??"0").split(".").length-1},I=E.content.split("\n"),O=I.every(e=>""===e.trim());O&&I.length>1&&I.pop();let V={node:{current:E,parent:C.parent??null,root:C.root??E,next:C.root?.children?.[C.index+1]??null,previous:C.root?.children?.[C.index-1]??null},pointer:F};return I.map((e,t)=>t<I.length-1?e+this.#c(V):e).join("")}return E.content}if("tag"===E.type){let q=this.#a.find(e=>e.name===E.name),K=E.children.map(e=>this.#i(e,C)).join(""),M=E.value?"="+E.value:"";if(!q){if(!0===z){let S={index:C.index??0,depth:(C.path??"0").split(".").length-1,path:C.path??"0"};return C.errors?.push({errorType:"unknown-tag",node:{current:E,parent:C.parent??null,root:C.root??E,next:C.root?.children?.[C.index+1]??null,previous:C.root?.children?.[C.index-1]??null},pointer:S}),K}return`[${E.name}${M}]${K}${E.closingPosition?`[/${E.name}]`:""}`}let U=E.children.map((e,t)=>this.#i(e,{...C,index:t,path:(C.path??"")+"."+t,parent:E})).join(""),Y={index:C.index??0,path:C.path??"0",depth:(C.path??"0").split(".").length-1},D={node:{current:E,parent:C.parent??null,root:C.root??E,next:C.root?.children?.[C.index+1]??null,previous:C.root?.children?.[C.index-1]??null},pointer:Y},{messages:G,override:H}=this.#j(D);if(G.length>0)return C.errors?.push(...G),H??"";let J={};for(let Q of q.attrNames){let X=this.parse(E.value??"").output;J[Q]=X}for(let ee of q.contentNames)J[ee]=U.trim();if("function"==typeof q.render)return q.render({node:{current:E,parent:C.parent??null,root:C.root??E,next:C.root?.children?.[C.index+1]??null,previous:C.root?.children?.[C.index-1]??null},pointer:Y,variables:J});let et=q.render;for(let en of q.fullVars){let er=J[en]??"",ei=RegExp(`\\$${en}`,"g");et=et.replace(ei,er)}return et}return"root"===E.type?E.children.map((e,t)=>this.#i(e,{index:t,path:`${t}`,parent:null,root:E,errors:C.errors??[]},z,L)).join(""):""}#e(eo){let el=eo.template.match(/^\[([a-z0-9*]+)(.*?)\](.*?)$/i);if(!el)throw Error("Invalid template format");let es=eo.name||el[1].toLowerCase(),ep=el[2],ea=el[3],eu=[...ep.matchAll(/\$([a-zA-Z0-9_]+)/g)].map(e=>e[1]),eh=[...ea.matchAll(/\$([a-zA-Z0-9_]+)/g)].map(e=>e[1]);return{name:es,render:eo.render,attrNames:eu,contentNames:eh,fullVars:[...new Set([...eu,...eh])]}}#f(ed){let ec=this.#d.inline,ef=this.#d.recursive,em="<<<NEWLINE>>>";ed=ed.replace(/\r?\n/g,em);let eg=RegExp(`\\[(${ef.join("|")})(=([^\\[\\]]|\\[[^\\[\\]]*\\])*)?\\]([\\s\\S]*?)\\[\\/\\1\\]`,"gi");ed=ed.replace(eg,(e,t,n="",r,i)=>{let o=this.#f(i.replaceAll(em,"\n"),ec,ef);return`[${t}${n}]${o}[/${t}]`});let ex=e=>{if(!e.trim()||/^\s*\[\*\]/.test(e))return!1;let t=[...e.matchAll(/\[\/?([a-zA-Z0-9*]+)[^\]]*\]/g)].map(e=>e[1].toLowerCase());return t.every(e=>ec.includes(e)||"text"===e)},ey=ed.split(em),e_=[],eb=[],ev=null,e$=!1,e9=()=>{if(eb.length){let e=eb.join(em);e_.push(e$||e.startsWith("[text]")?e:`[text]${e}[/text]`),eb=[]}},eT=RegExp(`^\\[(${ef.join("|")})(=.*)?$`,"i"),ew=RegExp(`^\\[\\/(${ef.join("|")})\\]$`,"i");for(let ej of ey){let eA=ej.trim();if(ev){ev+=em+ej,eA.endsWith("]")&&(e9(),e_.push(ev),e$=!0,ev=null);continue}eT.test(eA)&&!eA.endsWith("]")?ev=ej:eT.test(eA)?(e9(),e_.push(ej),e$=!0):ew.test(eA)?(e9(),e_.push(ej),e$=!1):""===eA?(e9(),e_.push("")):!e$&&ex(eA)?eb.push(ej):(e9(),e_.push(ej))}return e9(),e_.join(em).replaceAll(em,"\n")}}"undefined"!=typeof module&&module.exports?module.exports=EZPZ_BBCode_Parser:window.EZPZ_BBCode_Parser=EZPZ_BBCode_Parser;