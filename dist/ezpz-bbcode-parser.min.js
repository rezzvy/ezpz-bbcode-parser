class EZPZ_BBCode_Parser{constructor(e=[]){this.setRules(e),this.forbiddenRules=[],this.lineBreakTemplate=null}setRules(e){this.rules=e.map(e=>{let t=e.template.match(/^\[([a-z0-9*]+)(.*?)\](.*?)$/i);if(!t)throw Error("Invalid template format");let n=e.name||t[1].toLowerCase(),l=t[2],r=t[3],i=[...l.matchAll(/\$([a-zA-Z0-9_]+)/g)].map(e=>e[1]),o=[...r.matchAll(/\$([a-zA-Z0-9_]+)/g)].map(e=>e[1]);return{name:n,html:e.html,api:e.api??null,attrNames:i,contentNames:o,fullVars:[...new Set([...i,...o])]}})}forbidden(e){let t=[],n=(e,n="This is forbidden.")=>{let l={fn:e,msg:n,handler:null},r=e=>{l.handler=e};return t.push(l),{then:r}};e(n),this.forbiddenRules.push(...t)}checkForbidden(e){let t=[],n=null;for(let{fn:l,msg:r,handler:i}of this.forbiddenRules)if(l(e)&&(t.push({message:r,type:"forbidden",tag:e.node?.name,position:e.position??{}}),"function"==typeof i)){let o=i(e);void 0!==o&&null===n&&(n=o)}return{messages:t,override:n}}tokenize(e){let t=[],n=0,l=()=>{if("["!==e[n])return null;let t=n+1,l="",r="",i=!1,o=!1,a=0,p=n;if("/"===e[t]&&(i=!0,t++),!i&&"*"===e[t]&&"]"===e[++t]){let s=e.slice(n,t+1),h=t+1;return n=h,{type:"tag-open",name:"*",value:null,raw:s,position:{start:p,end:h}}}for(;t<e.length;){let d=e[t];if(!o&&"="===d){o=!0,t++;continue}if("["===d&&o&&a++,"]"===d){if(a>0)a--;else break}o?r+=d:l+=d,t++}if("]"!==e[t])return null;let u=e.slice(n,t+1),f=t+1;return n=f,{type:i?"tag-close":"tag-open",name:l.trim().toLowerCase(),value:o?r.trim():null,raw:u,position:{start:p,end:f}}};for(;n<e.length;){if("["===e[n]){let r=l();if(r){t.push(r);continue}}let i=e.indexOf("[",n);-1===i&&(i=e.length),t.push({type:"text",content:e.slice(n,i),position:{start:n,end:i}}),n=i}return t}buildTree(e,t=[]){let n={type:"root",children:[]},l=[{node:n,token:null}];for(let r=0;r<e.length;r++){let i=e[r],o=l[l.length-1].node;if("text"===i.type)o.children.push({type:"text",content:i.content,position:i.position});else if("tag-open"===i.type){if("*"===i.name){let a={type:"tag",name:"*",value:null,children:[],position:i.position};for(r++;r<e.length&&!("tag-open"===e[r].type&&("*"===e[r].name||"list"===e[r].name))&&!("tag-close"===e[r].type&&"list"===e[r].name);)a.children.push(e[r]),r++;r--,o.children.push(a)}else{let p={type:"tag",name:i.name,value:i.value,children:[],position:i.position};o.children.push(p),l.push({node:p,token:i})}}else if("tag-close"===i.type){let s=l[l.length-1];l.length>1&&s.node.name===i.name?l.pop():(o.children.push({type:"text",content:`[/${i.name}]`,position:i.position}),t?.push({message:`Unexpected closing tag: [/${i.name}]`,type:"unexpected-closing",tag:i.name,position:i.position}))}}for(let h=l.length-1;h>=1;h--){let{node:d,token:u}=l[h];t?.push({message:`Unclosed tag: [${d.name}]`,type:"unclosed-tag",tag:d.name,position:u?.position??{}})}return n}renderNode(e,t={}){if("text"===e.type){if("function"==typeof this.lineBreakTemplate){let n={index:t.index??0,path:t.path??"0",depth:(t.path??"0").split(".").length-1},l={node:e,parent:t.parent??null,root:t.root??e,position:n};return e.content.split("\n").map((e,t,n)=>t<n.length-1?e+this.lineBreakTemplate(l):e).join("")}return e.content}if("tag"===e.type){let r=this.rules.find(t=>t.name===e.name);if(!r){let i={index:t.index??0,depth:(t.path??"0").split(".").length-1,path:t.path??"0"};t.errors?.push({message:`Unknown tag: [${e.name}]`,type:"unknown-tag",tag:e.name,position:i});let o=e.children.map(e=>this.renderNode(e,t)).join(""),a=e.value?"="+e.value:"";return`[${e.name}${a}]${o}[/${e.name}]`}let p=e.children.map((n,l)=>this.renderNode(n,{...t,index:l,path:(t.path??"")+"."+l,parent:e})).join(""),s={index:t.index??0,path:t.path??"0",depth:(t.path??"0").split(".").length-1},h={node:e,parent:t.parent??null,root:t.root??e,position:s},{messages:d,override:u}=this.checkForbidden(h);if(d.length>0)return t.errors?.push(...d),u??"";let f={};for(let m of r.attrNames)f[m]=e.value??"";for(let c of r.contentNames)f[c]=p.trim();if("function"==typeof r.api)return r.api({variables:f,node:e,renderNode:e=>this.renderNode(e,t),parent:t.parent??null,position:s,root:t.root??e});let g=r.html;for(let y of r.fullVars){let $=f[y]??"",_=RegExp(`\\$${y}`,"g");g=g.replace(_,$)}return g}return"root"===e.type?e.children.map((n,l)=>this.renderNode(n,{index:l,path:`${l}`,parent:null,root:e,errors:t.errors??[]})).join(""):""}parse(e){let t=this.tokenize(e),n=[],l=this.buildTree(t,n),r=this.renderNode(l,{errors:n});return{html:r,errors:n,tree:l}}}"undefined"!=typeof module&&module.exports?module.exports=EZPZ_BBCode_Parser:window.EZPZ_BBCode_Parser=EZPZ_BBCode_Parser;